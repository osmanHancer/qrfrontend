<div class="persons-container">
  <!-- Header -->
  <div class="header">
    <h1>KiÅŸi YÃ¶netimi</h1>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="showAddPersonForm()">
        <i class="icon">+</i> Yeni KiÅŸi Ekle
      </button>
      <button class="btn btn-secondary" (click)="logout()">
        <i class="icon">ğŸšª</i> Ã‡Ä±kÄ±ÅŸ Yap
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-container">
    <input type="text" [(ngModel)]="searchTerm" (input)="searchPersons()"
      placeholder="Ad, soyad veya TC kimlik no ile ara..." class="search-input">
  </div>

  <!-- Add Person Form -->
  @if (showAddForm) {
  <div class="form-container">
    <div class="form-card">
      <h2>Yeni KiÅŸi Ekle</h2>
      <form (ngSubmit)="addPerson()">
        <div class="form-row">
          <div class="form-group">
            <label for="ad">Ad *</label>
            <input type="text" id="ad" [(ngModel)]="newPerson.ad" name="ad" required class="form-input">
          </div>
          <div class="form-group">
            <label for="soyad">Soyad *</label>
            <input type="text" id="soyad" [(ngModel)]="newPerson.soyad" name="soyad" required class="form-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="dogumTarihi">DoÄŸum Tarihi *</label>
            <input type="date" id="dogumTarihi" [(ngModel)]="newPerson.dogumTarihi" name="dogumTarihi" required
              class="form-input">
          </div>
          <div class="form-group">
            <label for="olumTarihi">Ã–lÃ¼m Tarihi</label>
            <input type="date" id="olumTarihi" [(ngModel)]="newPerson.olumTarihi" name="olumTarihi" class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label for="media">FotoÄŸraflar ve Videolar</label>
          <input type="file" id="media" (change)="onImageSelected($event)" multiple accept="image/*,video/*"
            class="form-input">

        </div>

        <div class="form-group">
          <label for="konum">Konum (Enlem, Boylam)</label>
          <input type="text" id="konum" [(ngModel)]="newPerson.konum" name="konum" 
            placeholder="Ã–rn: 41.0082, 28.9784 veya Merkez MezarlÄ±ÄŸÄ±, A Blok, 15. Parsel" class="form-input">
          <small class="form-help-text">Enlem ve boylam koordinatlarÄ± (Ã¶rn: 41.0082, 28.9784) veya adres bilgisi girebilirsiniz.</small>
        </div>

        <div class="form-group">
          <label for="biyografi">Biyografi</label>
          <quill-editor [(ngModel)]="newPerson.biyografi" name="biyografi" [styles]="{height: '200px'}" format="html">
          </quill-editor>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">KiÅŸi Ekle</button>
          <button type="button" class="btn btn-secondary" (click)="cancelForm()">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Edit Person Form -->
  @if (showEditForm) {
  <div class="form-container">
    <div class="form-card">
      <h2>KiÅŸi DÃ¼zenle</h2>
      <form (ngSubmit)="updatePerson()">
        <div class="form-row">
          <div class="form-group">
            <label for="edit-ad">Ad *</label>
            <input type="text" id="edit-ad" [(ngModel)]="editPerson.ad" name="edit-ad" required class="form-input">
          </div>
          <div class="form-group">
            <label for="edit-soyad">Soyad *</label>
            <input type="text" id="edit-soyad" [(ngModel)]="editPerson.soyad" name="edit-soyad" required
              class="form-input">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit-dogumTarihi">DoÄŸum Tarihi *</label>
            <input type="date" id="edit-dogumTarihi" [(ngModel)]="editPerson.dogumTarihi" name="edit-dogumTarihi"
              required class="form-input">
          </div>
          <div class="form-group">
            <label for="edit-olumTarihi">Ã–lÃ¼m Tarihi</label>
            <input type="date" id="edit-olumTarihi" [(ngModel)]="editPerson.olumTarihi" name="edit-olumTarihi"
              class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label for="edit-images">Yeni FotoÄŸraflar ve Videolar Ekle</label>
          <input type="file" id="edit-images" (change)="onImageSelected($event)" multiple accept="image/*,video/*"
            class="form-input">
        </div>

        <div class="form-group">
          <label for="edit-konum">Konum (Enlem, Boylam)</label>
          <input type="text" id="edit-konum" [(ngModel)]="editPerson.konum" name="edit-konum" 
            placeholder="Ã–rn: 41.0082, 28.9784 veya Merkez MezarlÄ±ÄŸÄ±, A Blok, 15. Parsel" class="form-input">
          <small class="form-help-text">Enlem ve boylam koordinatlarÄ± (Ã¶rn: 41.0082, 28.9784) veya adres bilgisi girebilirsiniz.</small>
        </div>

        <div class="form-group">
          <label for="edit-biyografi">Biyografi</label>
          <quill-editor #editQuillEditor [(ngModel)]="editPerson.biyografi" name="edit-biyografi" [styles]="{height: '200px'}"
            format="html" (onEditorCreated)="onEditEditorCreated($event)">
          </quill-editor>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
          <button type="button" class="btn btn-secondary" (click)="cancelForm()">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Persons List -->
  <div class="persons-list">
    <div class="list-header">
      <h3>KiÅŸiler ({{filteredPersons.length}})</h3>
    </div>

    @if (filteredPersons.length > 0) {
    <div class="persons-grid">
      <div class="person-card" *ngFor="let person of filteredPersons">
        <div class="person-header">
          <h4>{{person.ad}} {{person.soyad}}</h4>
          <div class="person-actions">
            <button class="btn btn-sm btn-primary" (click)="showEditPersonForm(person)">
              <i class="icon">âœï¸</i>
            </button>
            <button class="btn btn-sm btn-danger" (click)="deletePerson(person)">
              <i class="icon">ğŸ—‘ï¸</i>
            </button>
          </div>
        </div>

        <div class="person-info">
          <p><strong>TC No:</strong> {{person.tcno}}</p>
          <p><strong>DoÄŸum:</strong> {{formatDate(person.dogumTarihi)}}</p>
          @if (person.olumTarihi) {
          <p><strong>Ã–lÃ¼m:</strong> {{formatDate(person.olumTarihi)}}</p>
          }
        </div>
        <!-- 
          <div class="person-bio" *ngIf="person.biyografi">
            <h5>Biyografi</h5>
            <div class="bio-content ql-editor" [innerHTML]="person.biyografi"></div>
          </div> -->

        <!-- Images Section (sadece dÃ¼zenleme modunda ve seÃ§ili kiÅŸi iÃ§in) -->
        @if (showEditForm && selectedPerson?.tcno === person.tcno) {
        <div class="person-images">
          <h5>FotoÄŸraflar ve Videolar ({{personImages[person.tcno]?.length || 0}}):</h5>

          <div class="image-upload">
            <input type="file" [id]="'image-upload-' + person.id"
              (change)="onImageSelectedForPerson($event, person.tcno)" multiple accept="image/*,video/*"
              class="image-upload-input">
            <label [for]="'image-upload-' + person.id" class="image-upload-label">
              <i class="icon">ğŸ“·</i> FotoÄŸraf/Video Ekle
            </label>
          </div>

          @if (personImages[person.tcno] && personImages[person.tcno].length > 0) {
          <div class="images-grid">
            <div class="image-item" *ngFor="let image of personImages[person.tcno]; let i = index">
              <img *ngIf="!isVideoFile(image)" [src]="getImageUrl(person.tcno, image)" [alt]="person.ad + ' ' + person.soyad" class="person-image"
                (error)="onImageError($event, image, person.tcno)" (load)="onImageLoad($event, image, person.tcno)">
              <video *ngIf="isVideoFile(image)" [src]="getImageUrl(person.tcno, image)" class="person-video" preload="metadata" controls>
                <source [src]="getImageUrl(person.tcno, image)" type="video/mp4">
                TarayÄ±cÄ±nÄ±z video oynatmayÄ± desteklemiyor.
              </video>
              <div class="image-info">
                <small>{{image}}</small>
              </div>
              <button class="btn btn-sm btn-danger remove-image" (click)="removeImage(person.tcno, image)">
                <i class="icon">âŒ</i>
              </button>
            </div>
          </div>
          } @else {
          <div class="no-images">
            <p>HenÃ¼z fotoÄŸraf veya video eklenmemiÅŸ</p>
          </div>
          }
        </div>
        }

        <!-- QR Code Section -->
        <div class="person-qr">
          <h5>QR Kod:</h5>
          <div class="qr-container">
            @if (person.qrKod) {
            <img [src]="getQRCodeUrl(person.tcno)" [alt]="'QR Kod - ' + person.ad + ' ' + person.soyad"
              class="qr-image">
            <button class="btn btn-sm btn-primary" (click)="downloadQRCode(person.tcno, person.ad, person.soyad)">
              <i class="icon">â¬‡ï¸</i> Ä°ndir
            </button>
            } @else {
            <div class="no-qr">
              <p>QR kod oluÅŸturulmamÄ±ÅŸ</p>
              <button class="btn btn-sm btn-success" (click)="generateQRCode(person.tcno)">
                <i class="icon">ğŸ”—</i> QR Kod OluÅŸtur
              </button>
            </div>
            }
          </div>
        </div>
      </div>
    </div>
    } @else {
    <div class="no-persons">
      <p>HenÃ¼z kiÅŸi eklenmemiÅŸ.</p>
      <button class="btn btn-primary" (click)="showAddPersonForm()">Ä°lk KiÅŸiyi Ekle</button>
    </div>
    }
  </div>
</div>